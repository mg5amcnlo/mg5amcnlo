      SUBROUTINE LOOP_%(nloopline)d%(nwfsargs_header)s(%(pairingargs)s%(wfsargs)s%(margs)s RANK, SQUAREDSOINDEX, LOOPNUM)

      INTEGER    NEXTERNAL
      PARAMETER (NEXTERNAL=%(nexternal)d)
      INTEGER    NLOOPLINE
      PARAMETER (NLOOPLINE=%(nloopline)d)
	  INTEGER    NWAVEFUNCS
      PARAMETER (NWAVEFUNCS=%(nwavefuncs)d)
      INTEGER    NLOOPGROUPS
      PARAMETER (NLOOPGROUPS=%(nloop_groups)d)
	  INTEGER    NCOMB
      PARAMETER (NCOMB=%(ncomb)d)
C     These are constants related to the split orders
      INTEGER    NSQUAREDSO
	  PARAMETER (NSQUAREDSO=%(nSquaredSO)d)
C
C ARGUMENTS 
C
      INTEGER %(wfsargsdecl)s
      %(mass_dp_format)s %(margsdecl)s
      %(pairingdecl)s
      INTEGER RANK, LSYMFACT
	  INTEGER SQUAREDSOINDEX, LOOPNUM
C
C LOCAL VARIABLES 
C
      %(real_dp_format)s PL(0:3,NLOOPLINE)
      %(mass_dp_format)s M2L(NLOOPLINE)
      INTEGER PAIRING(NLOOPLINE),WE(%(nwfsargs)d)
      INTEGER I, J, K, TEMP
C
C GLOBAL VARIABLES
C
      INCLUDE 'MadLoopParams.inc'
      INTEGER ID,SQSOINDEX,R
      COMMON/LOOP/ID,SQSOINDEX,R

	  LOGICAL CHECKPHASE, HELDOUBLECHECKED
      common/INIT/CHECKPHASE, HELDOUBLECHECKED

	  INTEGER HELOFFSET
	  INTEGER GOODHEL(NCOMB)
	  LOGICAL GOODAMP(NSQUAREDSO,NLOOPGROUPS)
	  common/Filters/GOODAMP,GOODHEL,HELOFFSET

	  %(complex_dp_format)s LOOPRES(3,NSQUAREDSO,NLOOPGROUPS)
	  LOGICAL S(NSQUAREDSO,NLOOPGROUPS)
	  common/LOOPRES/LOOPRES,S

	  %(complex_dp_format)s W(20,NWAVEFUNCS)
	  common/W/W  

C ----------
C BEGIN CODE
C ----------

	  IF (CHECKPHASE.OR.(.NOT.HELDOUBLECHECKED).OR.GOODAMP(SQUAREDSOINDEX,LOOPNUM)) THEN
	  %(weset)s
      %(mset)s
      %(pairingset)s
	  R=RANK
      ID=LOOPNUM
	  SQSOINDEX=SQUAREDSOINDEX
      DO I=0,3
        TEMP=1
        DO J=1,NLOOPLINE
		  PL(I,J)=0.D0
          DO K=TEMP,(TEMP+PAIRING(J)-1)
            PL(I,J)=PL(I,J)-DBLE(W(1+I,WE(K)))
          ENDDO
          TEMP=TEMP+PAIRING(J)
        ENDDO
      ENDDO
      IF(MLReductionLib(1).EQ.1)THEN
C USE CUTTOOLS
	CALL CTLOOP(NLOOPLINE,PL,M2L,RANK,LOOPRES(1,SQUAREDSOINDEX,LOOPNUM),S(SQUAREDSOINDEX,LOOPNUM))
      ELSE
C USE TIR
	CALL TIRLOOP(SQUAREDSOINDEX,LOOPNUM,NLOOPLINE,PL,M2L,RANK,LOOPRES(1,SQUAREDSOINDEX,LOOPNUM),S(SQUAREDSOINDEX,LOOPNUM)) 
      ENDIF
	  ELSE
	    LOOPRES(1,SQUAREDSOINDEX,LOOPNUM)=0.0d0
	    LOOPRES(2,SQUAREDSOINDEX,LOOPNUM)=0.0d0
	    LOOPRES(3,SQUAREDSOINDEX,LOOPNUM)=0.0d0
		S(SQUAREDSOINDEX,LOOPNUM)=.TRUE.
	  ENDIF
      END
